"use strict"

const basicAuth = require("basic-auth")
const sendPlace = require("send-place")
const persistence = require("persistence")

module.exports = {
  "title": "Code erroné",
  "description": "Un long bip vous indique que le code est erroné.",
  "links": [
    {
      "description": "Retourner à l'entrée du couloir",
      "href": "corridor",
      "rel": ["move", "backward", "back", "prev"]
    },
    {
      "description": "Examiner la porte",
      "href": "third_door",
      "rel": ["look", "detail"]
    }
  ],
  "actions": [
    {
      "name": "open_door",
      "description": "Ouvrir la porte",
      "method": "GET",
      "href": "digicode",
      "handler": handler
    }
  ],
  "authorized": {
    "title": "Ouverture de la porte",
    "description": "La porte s'ouvre puis se referme derrière vous.",
    "location": "control_room"
  }
}

function handler(place, action, request, response) {
  const credentials = basicAuth(request)
  persistence.with("digicode", function(digicode) {
    if (credentials && credentials.pass && credentials.pass === "2342") {
      return authorized(digicode.authorized, response)
    } else if (request.body && request.body.code === "2342") {
      return authorized(digicode.authorized, response)
    } else {
      return unauthorized(digicode, response)
    }
  })
}

function authorized(place, response) {
    response.status(200).location(place.location)
    sendPlace(response, place)
}

function unauthorized(place, response) {
    response.status(401)
    response.set("WWW-Authenticate", 'Basic realm="death_star"')
    sendPlace(response, place)
}
