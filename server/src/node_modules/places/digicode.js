"use strict"

const basicAuth = require("basic-auth")
const sendPlace = require("../send-place")

module.exports = {
  "title": "Code erroné",
  "description": "Un long bip vous indique que le code est erroné.",
  "links": [
    {
      "description": "Retourner à l'entrée du couloir",
      "href": "corridor"
    },
    {
      "description": "Examiner la porte",
      "href": "third_door"
    }
  ],
  "actions": [
    {
      "name": "open_door",
      "description": "Ouvrir la porte",
      "method": "GET",
      "href": "digicode",
      "handler": handler
    }
    /*{
      "name": "enter_digicode",
      "title": "Entrer un digicode",
      "description": "Entrer un digicode",
      "method": "POST",
      "href": "digicode",
      "type": "application/x-www-form-urlencoded",
      "fields": [
        {"name": "code", "type": "text"}
      ],
      "handler": handler
    }*/
  ],
  "authorized": {
    "title": "Ouverture de la porte",
    "description": "La porte s'ouvre puis se referme derrière vous.",
    "location": "control_room"
  }
}

function handler(place, action, request, response) {
  const credentials = basicAuth(request)
  if (credentials && credentials.pass && credentials.pass === "2342") {
    return authorized(action, response)
  } else if (request.body && request.body.code === "2342") {
    return authorized(action, response)
  } else {
    return unauthorized(action, response)
  }
}

function authorized(action, response) {
    response.status(200).location(action.unhref.authorized.location)
    sendPlace(response, action.unhref.authorized)
}

function unauthorized(action, response) {
    response.status(401)
    response.set("WWW-Authenticate", 'Basic realm="death_star"')
    sendPlace(response, action.unhref)
}
