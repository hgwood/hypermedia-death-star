"use strict"

const persistence = require("persistence")
const sendPlace = require("send-place")
const countdown = process.argv[2] === "--obs" ? 30 : 5 // seconds

module.exports = {
  "description": `L'écran affiche: "Extinction en cours. Temps restant: ${countdown} secondes."`,
  "links": [
    {
      "description": "Regarder l'écran",
      "href": "shutdown_progress",
      "rel": ["look", "detail"]
    }
  ],
  "countdown": countdown,
  "handler": handler,
  "locationAfterCountdown": "vader"
}

function handler(place, request, response) {
  persistence.with("shutdown_progress", function(shutdownProgress) {
    if (shutdownProgress.remaining <= 0) {
      shutdownProgress.location = shutdownProgress.locationAfterCountdown
      response.status(303).location(shutdownProgress.location).send()
    } else {
      sendPlace(response, shutdownProgress)
    }
  })
}
