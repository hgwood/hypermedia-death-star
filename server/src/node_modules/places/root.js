"use strict"

const shortid = require("shortid")
const sendPlace = require("send-place")
const persistence = require("persistence")

module.exports = {
  "id": "root",
  "title": "The Shadow of the Death Star",
  "description": "Il est trop tard pour faire demi-tour. Vous sentez le poigne de fer de l'Empire Galactique se refermer sur vous. La lutte est veine, mais il y a d'autres façons de remporter la victoire. Votre maîtrise des pouvoirs de l'HTTP sera indispensable à votre survie. Saurez-vous affronter l'impitoyable Vador ?",
  "actions": [
    {
      "name": "start",
      "title": "Commencer",
      "description": "Pour commencer, faites un POST avec votre nom dans une variable 'name'.",
      "method": "POST",
      "href": "$self",
      "type": "application/x-www-form-urlencoded",
      "fields": [
        {"name": "name", "type": "text"}
      ],
      "returnedLocation": "landing",
      "handler": handler
    }
  ]
}

function handler(place, action, request, response) {
  if (!request.is(module.exports.actions[0].type)) return response.status(415).send()
  if (!request.body.name) return response.status(400).type("text/plain").send("Could not find non-empty 'name' field in the body of this request")
  const location = action.returnedLocation.replace(/:\w/, shortid.generate())
  // console.log(action.returnedLocation, location)
  response.status(201).location(location)
  sendPlace.location(response, location)
  persistence.createGame(request.body.name)
}
