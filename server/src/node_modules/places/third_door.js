"use strict"

const persistence = require("persistence")
const sendPlace = require("send-place")
const digicode = require("places/digicode")

module.exports = {
  "title": "La troisième porte",
  "description": "Un petit papier jaune de forme carré est collé sur la porte. Y est griffoné : \"2342\". Dans le coin est indiqué: \"9th light, premier fournisseur d'Agilité\".",
  "clue": "2342",
  "links": [digicode.links[0]],
  "actions": [
    digicode.actions[0],
    {
      "name": "write",
      "description": "Ecrire quelque chose sur le papier",
      "method": "PATCH",
      "href": "$self",
      "type": "application/x-www-form-urlencoded",
      "fields": [
        {"name": "text", "type": "text"}
      ],
      "handler": handler
    }
  ]
}

function handler(place, action, request, response) {
  if (!request.is(action.type)) return response.status(415).send()
  if (!request.body.text) return response.status(400).type("text/plain").send("Could not find non-empty 'text' field in the body of this request")
  persistence.with("third_door", function(thirdDoor) {
    thirdDoor.description = thirdDoor.description.replace(
      /Y est griffoné : ".*?"/, `Y est griffoné : "${request.body.text}"`)
    thirdDoor.clue = request.body.text
    response.status(205).send()
  })
}
