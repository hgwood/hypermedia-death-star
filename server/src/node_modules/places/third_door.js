"use strict"

const sendPlace = require("../send-place")
const digicode = require("./digicode")

module.exports = {
  "title": "La troisième porte",
  "description": "Un petit papier jaune de forme carré est collé sur la porte. Y est griffoné : '2342'. Dans le coin est indiqué: \"9th light, premier fournisseur d'Agilité\".",
  "links": [digicode.links[0]],
  "actions": [
    digicode.actions[0],
    {
      "name": "write",
      "description": "Ecrire quelque chose sur le papier",
      "method": "PATCH",
      "href": "$self",
      "type": "application/x-www-form-urlencoded",
      "fields": [
        {"name": "text", "type": "text"}
      ],
      "handler": handler
    }
  ]
}

function handler(place, action, request, response) {
  console.log("req", request.body)
  if (!request.is(module.exports.actions[1].type)) return response.status(415).send()
  if (!request.body.text) return response.status(400).type("text/plain").send("Could not find non-empty 'text' field in the body of this request")
  module.exports.description = module.exports.description
    .replace(/Y est griffoné : '.*?'/, `Y est griffoné : '${request.body.text}'`)
  sendPlace(response, place)
}
