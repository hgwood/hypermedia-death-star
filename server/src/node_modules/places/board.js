"use strict"

const _ = require("lodash")
const sendPlace = require("send-place")
const persistence = require("persistence")
const routes = require("places/routes")

module.exports = {
  ranged: "columns",
  handler: handler,
  columns: [
    {
      "description": `La colonne "To do" contient deux papiers sur lesquels sont écrits de courts messages. Le premier dit "Trouver les pouvoirs de l'Hypermedia !"`,
      "links": [
        {
          "description": "Aller au cinéma",
          "href": "cinema",
          "rel": ["happiness"],
          "hidden": true
        }
      ],
      "actions": [
        {
          "name": "power!",
          "description": "Trouver les pouvoirs de l'Hypermedia",
          "method": "POST",
          "href": "hypermedia",
          "returnedLocation": "$self",
          "handler": powerHandler
        }
      ]
    },
    {
      "description": `Le colonne "Doing" contient un unique papier, sur lequel est écrit "Examiner ce tableau".`
    },
    {
      "description": `La colonne "Done" contient plusieurs papiers sur lesquels sont écrits de courts messages: "Se faire capturer par l'étoile noire", "Eteindre le rayon tracteur", "DELETE /vader", "Remonter dans le temps", "Noter le code sur la porte pour permettre à votre double du passé d'ouvrir".`
    },
  ]
}

let defaultColumn = 1

function handler(place, request, response) {
  const rangeHeader = request.get("Range") || `columns=${defaultColumn}-${defaultColumn}`
  const pageNumber = Number(rangeHeader.match(/columns=(\d)\-\d/)[1])
  if (!place.columns[pageNumber]) return response.sendStatus(416)
  response.set("Content-Range", `columns ${pageNumber}-${pageNumber}/${place.columns.length}`).status(206)
  persistence.with("board", function(board) {
    sendPlace(response, board.columns[pageNumber])
  })
}

function powerHandler(place, action, request, response) {
  defaultColumn = 0
  persistence.with(place.id, function(board) {
    board.columns[0].description += `. Le second dit "Aller voir Star Wars Episode VII Le Réveil de la Force au cinéma le 16 décembre !"`
    board.columns[0].links[0].hidden = false
    board.columns[0].actions[0].hidden = true
  })
  response.location(action.returnedLocation).status(302)
  persistence.with(action.hrefId, function(hypermedia) {
    persistence.readAll(_.keys(routes), function(allPlaces) {
      _.each(allPlaces, function(place) {
        if (place.id === "hypermedia" || place.id === "cinema") return
        place.fail = true
      })
      hypermedia.links = _(allPlaces).reject(place => place.id === "cinema").map("links").compact().flatten().shuffle().value()
      sendPlace(response, hypermedia)
    })
  })
}
