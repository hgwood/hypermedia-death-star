"use strict"

const _ = require("lodash")
const routes = require("places/routes")

module.exports = render

function render(placeId, place, uri) {
  if (place.rendered) return place
  // console.log("place", placeId, uri, _.map(place.actions, "href"))
  // if (!render.stack) render.stack = []
  // if (render.stack.length > 10) return
  place.rendered = true
  // render.stack.push(0)
  console.log("place 2", placeId, uri, place.actions)
  // place = _.cloneDeep(place)
  _.each(place.actions, action => {
    if (action.rendered) return
    action.rendered = true
    // if (action.href === placeId) return
    // if (action.href !== "$self") action.unhref = render(action.href, _.cloneDeep(require(`places/${action.href}`)), routes[action.href])
    // console.log("action.href before", placeId, action.description, action.href)
    action.hrefId = action.href
    action.href = renderLink(action.href, uri)
    // console.log("action.href after", placeId, action.description, action.href)
    if (action.returnedLocation) action.returnedLocation = renderLink(action.returnedLocation, uri)
    if (!action.method) action.method = "GET"
  })
  if (!place.links) place.links = []
  place.links.push({name: "self", rel: ["self"], href: placeId, description: "\u27F2"})
  _.each(place.links, link => {
    if (link.rendered) return
    link.rendered = true
    link.href = renderLink(link.href, uri)
  })
  if (place.authorized && place.authorized.location) place.authorized.location = renderLink(place.authorized.location, uri)
  if (place.locationAfterCountdown) place.locationAfterCountdown = renderLink(place.locationAfterCountdown, uri)
  if (place.locationAfterDelete) place.locationAfterDelete = renderLink(place.locationAfterDelete, uri)
  // render.stack.pop()
  return place
}

function renderLink(linkTemplate, reference) {
  if (linkTemplate === "$self") return reference.replace(/:\w+/, "game")
  // console.log("linkTemplate", linkTemplate, routes[linkTemplate])
  console.log(linkTemplate)
  return routes[linkTemplate].replace(/:\w+/, "game")
}
