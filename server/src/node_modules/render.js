"use strict"

const _ = require("lodash")
const routes = require("places/routes")

module.exports = render

function render(placeId, place, uri) {
  if (place.rendered) return place
  place.rendered = true
  _.each(place.actions, action => {
    if (action.rendered) return
    action.rendered = true
    action.hrefId = action.href
    action.href = renderLink(action.href, uri)
    if (action.returnedLocation) action.returnedLocation = renderLink(action.returnedLocation, uri)
    if (!action.method) action.method = "GET"
  })
  if (!place.links) place.links = []
  place.links.push({name: "self", rel: ["self"], href: placeId, description: "\u27F2"}) // that's a rotating arrow
  _.each(place.links, link => {
    if (link.rendered) return
    link.rendered = true
    link.href = renderLink(link.href, uri)
  })
  if (place.authorized && place.authorized.location) place.authorized.location = renderLink(place.authorized.location, uri)
  if (place.location) place.location = renderLink(place.location, uri)
  if (place.locationAfterCountdown) place.locationAfterCountdown = renderLink(place.locationAfterCountdown, uri)
  if (place.locationAfterDelete) place.locationAfterDelete = renderLink(place.locationAfterDelete, uri)
  if (place.locationAfterCodeWrittenOnThirdDoor) place.locationAfterCodeWrittenOnThirdDoor = renderLink(place.locationAfterCodeWrittenOnThirdDoor, uri)
  if (place.ranged) {
    _.each(place[place.ranged], subplace => render(placeId, subplace, uri))
  }
  return place
}

function renderLink(linkTemplate, reference) {
  // console.log("renderLink", linkTemplate, reference)
  if (linkTemplate[0] === "!") return linkTemplate.substring(1)
  if (linkTemplate === "$self") return reference.replace(/:\w+/, "game")
  return routes[linkTemplate].replace(/:\w+/, "game")
}
