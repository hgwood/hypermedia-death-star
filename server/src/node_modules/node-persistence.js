"use strict"

const _ = require("lodash")
const render = require("render")
const routes = require("places/routes")

module.exports = {
  createGame: createGame,
  with: _with,
  readAll: readAll
}

function createGame(playerName) {
  // nothing
}

function get(placeId, callback) {
  console.log(placeId, routes[placeId])
  const placeFromFs = require(`places/${placeId}`)
  const placeToReturn = placeFromFs.rendered ? placeFromFs : render(placeId, placeFromFs, routes[placeId])
  callback(placeToReturn)
}

function set(placeId, place) {
  // nothing
}

function _with(placeId, transform) {
  get(placeId, function(place) {
    if (transform(place) !== false) set(placeId, place)
  })
}

function readAll(placeIds, callback) {
  const places = _.map(placeIds, () => false)
  function unitCallback(index, place) {
    places[index] = place
    if (_.all(places)) callback(places)
  }
  _.each(placeIds, (placeId, index) => get(placeId, _.partial(unitCallback, index)))
}
