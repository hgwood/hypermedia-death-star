"use strict"

const _ = require("lodash")

module.exports = function sendPlace(response, place) {
  response.format({
    "text/plain": function() {
      response.render("place.mustache", place)
    },
    "text/html": function() {
      response.render("place.jade", place)
    },
    "application/json": () => json(response, place),
    "application/vnd.siren+json": () => siren(response, place),
    "default": function() {
      response.status(406).send("Not Acceptable")
    }
  })
}

function json(response, place) {
  const actions = {actions: _.map(place.actions, action => _.pick(action, "name", "description", "method", "href", "type", "fields"))}
  const jsonPlace = _.assign(actions, _.pick(place, "title", "description"))
  response.send(jsonPlace)
}

function siren(response, {title, description, links, actions}) {
  const sirenPlace = {
    class: ["place"],
    properties: {title, description},
    actions: _.map(_.filter(actions, action => !action.hidden), ({name, description, href, method, type, fields}) => ({
      name,
      title: description,
      href: console.log("href", href) || href,
      method,
      type,
      fields
    })),
    links: _.map(_.filter(links, link => !link.hidden), ({description, href, rel}) => ({
      rel: rel || [],
      title: description,
      href
    }))
  }
  const linkHeader = _.transform(links, (linkHeaderObject, link) => linkHeaderObject[link.rel[0]] = link.href, {})
  console.log(linkHeader)
  response.links(linkHeader).send(sirenPlace)
}

module.exports.location = function sendLocation(response, location) {
  const place = {
    title: "",
    description: "",
    location: location
  }
  module.exports(response, place)
}
