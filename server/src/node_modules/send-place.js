"use strict"

const _ = require("lodash")

module.exports = function sendPlace(response, place) {
  response.format({
    "text/plain": function() {
      response.render("place.mustache", place)
    },
    "text/html": function() {
      response.render("place.jade", place)
    },
    "application/json": () => json(response, place),
    "application/vnd.siren+json": () => siren(response, place),
    "default": function() {
      response.status(406).send("Not Acceptable")
    }
  })
}

function json(response, place) {
  const actions = {actions: _.map(place.actions, action => _.pick(action, "name", "description", "method", "href", "type", "fields"))}
  const jsonPlace = _.assign(actions, _.pick(place, "title", "description"))
  response.send(jsonPlace)
}

function siren(response, {title, description, links, actions}) {
  const sirenPlace = {
    class: ["place"],
    properties: {title, description},
    actions: _.map(actions, ({name, description, href, method, type, fields}) => ({
      name,
      title: description,
      href,
      method,
      type,
      fields
    })),
    links: _.map(links, ({description, href}) => ({
      rel: [],
      title: description,
      href
    }))
  }
  response.send(sirenPlace)
}

module.exports.location = function sendLocation(response, location) {
  response.format({
    "text/plain": () => response.send(`Next: GET ${location}`),
    "text/html": () => response.send(`Next: <a href="${location}">here</a>`),
    "application/json": () => response.send({location: location}),
    "application/vnd.siren+json": () => response.send(),
    "default": () => response.status(406).send("Not Acceptable")
  })
}
