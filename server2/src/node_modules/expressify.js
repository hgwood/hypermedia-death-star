"use strict"

const _ = require("lodash")
const express = require("express")
const bodyParser = require("body-parser")
const getResource = require("get-resource")
const handleGet = require("handle-get")

module.exports = function expressify(router) {
  const app = express()
  app.use(bodyParser.urlencoded({extended: false}))
  _.each(router.routes, function(uri, resourceId) {
    const resource = getResource(resourceId, router)
    console.log("resource", resource)
    app.get(uri, function(request, response) {
      handleGet(uri, resource, response)
    })
    _.each(resource.actions, function(action) {
      app[action.method.toLowerCase()](uri, handler(action))
    })
  })
  return app
}

function handler({type, fields, handle}) {
  return function(request, response) {
    if (type && !request.is(type)) return response.status(415).send()
    if (fields && !allFieldsPresent(fields, request)) return response.status(400).send()
    handle(request, response)
  }
}

function allFieldsPresent(fields, request) {
  return request.body && _.all(fields, ({name}) => request.body[name])
}
